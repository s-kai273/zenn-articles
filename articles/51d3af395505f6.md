---
title: "VSCodeVimã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’è§£èª¬ã—ã¦ã¿ãŸ"
emoji: "ğŸ’­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---

## ã¯ã˜ã‚ã«

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

ä»Šå›ã¯åŸºæœ¬çš„ãªã‚­ãƒ¼å…¥åŠ›ã‹ã‚‰ã‚¨ãƒ‡ã‚£ã‚¿ã«å®Ÿéš›ã«åæ˜ ã•ã‚Œã‚‹ã¨ã“ã‚ã¾ã§ã‚’è§£èª¬ã—ã¾ã™ã€‚  
VSCodeVim ã¯ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã«ã‚ˆã‚‹å‡¦ç†ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚ã€å…¥åŠ›ã•ã‚ŒãŸã‚­ãƒ¼ã‚’ä¸€ã¤ãšã¤å‡¦ç†ã—ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«çŠ¶æ…‹ç®¡ç†ã‚„ã‚¨ãƒ‡ã‚£ã‚¿ã®å†…å®¹ã®ä¿®æ­£ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚  
ãã‚Œã‚’å®Ÿç¾ã™ã‚‹å¤§ã¾ã‹ãªæµã‚Œã¯ä¸‹è¨˜ã§ã™ã€‚

1. ã‚­ãƒ¼å…¥åŠ›ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
2. ã‚­ãƒ¼ã‹ã‚‰ Action ã®å–å¾—
3. Action ã®å®Ÿè¡Œ
4. Transformation ã®å®Ÿè¡Œ

ã“ã‚Œã‚‰ã«ã¤ã„ã¦ã€ãã‚Œãã‚Œè©³ã—ãè¦‹ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

## ã‚­ãƒ¼å…¥åŠ›ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

ã“ã“ãŒå‡¦ç†ç³»ã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã«ãªã‚Šã¾ã™ã€‚  
ã¾ãšã‚­ãƒ¼å…¥åŠ›ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’ã™ã‚‹ä¸Šã§è€ƒãˆã¦ã‚‚ã‚‰ã„ãŸã„ã®ãŒã€ã“ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’æœ‰åŠ¹ã«ã—ã¦ã„ãªã„çŠ¶æ…‹ã§ä¿®é£¾ã‚­ãƒ¼ä»¥å¤–ã®æ–‡å­—ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ãã®å†…å®¹ãŒã‚¨ãƒ‡ã‚£ã‚¿ä¸Šã«å…¥åŠ›ã•ã‚Œã¾ã™ã€‚  
ä¾‹ãˆã°ã€Œiã€ã¨ã„ã†ã‚­ãƒ¼ã‚’å…¥åŠ›ã™ã‚Œã°ã€å½“ãŸã‚Šå‰ã§ã™ãŒã€ã‚¨ãƒ‡ã‚£ã‚¿ä¸Šã§ã¯ã€Œiã€ã¨ã„ã†æ–‡å­—ãŒå…¥åŠ›ã•ã‚Œã‚‹ã‚ã‘ã§ã™ã€‚

ä¸€æ–¹ Vim ã®ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãªã‚‰ã©ã†ãªã‚‹ã®ã‹ï¼Ÿ  
ã€Œiã€ã¨ã„ã†æ–‡å­—ã‚’å…¥åŠ›ã—ã¦ã‚‚ãã‚ŒãŒã‚¨ãƒ‡ã‚£ã‚¿ä¸Šã«å…¥åŠ›ã•ã‚Œã‚‹ã®ã‹ã¯ã€ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã‚Šã¾ã™ã€‚  
ä¾‹ãˆã° Normal ãƒ¢ãƒ¼ãƒ‰ä¸­ã®å…¥åŠ›ãªã‚‰ Insert ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™ã—ã€Insert ãƒ¢ãƒ¼ãƒ‰ä¸­ã®å…¥åŠ›ãªã‚‰ã€Œiã€ãŒã‚¨ãƒ‡ã‚£ã‚¿ä¸Šã«å…¥åŠ›ã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚

ã“ã“ã‹ã‚‰ã‚ã‹ã‚‹ã“ã¨ã¨ã—ã¦ã€Vim ã®ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã§ã¯ä¸€ã¤ã®ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ã‚‚ãã‚Œã«ã‚ˆã‚‹æŒ™å‹•ã¯ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ã—ã€ã¨ã‚Šã‚ãˆãšã‚¨ãƒ‡ã‚£ã‚¿ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«å¼·åˆ¶çš„ã«ãã®æ–‡å­—ã‚’å…¥åŠ›ã™ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæŒ™å‹•ã¯éƒ½åˆãŒæ‚ªã„ã§ã™ã€‚

ãªã®ã§ VSCodeVim ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæŒ™å‹•ã‚’æœ¬ãƒ—ãƒ©ã‚°ã‚¤ãƒ³å°‚ç”¨ã®å‡¦ç†ã«ä¸Šæ›¸ãã—ã¦ã„ã¾ã™ã€‚  
æ–‡å­—ã®å…¥åŠ›ã®ä»•æ–¹ã§ç™ºç«ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ãŒç•°ãªã‚‹ãŸã‚ã€å®Ÿéš›ã¯è¤‡æ•°ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä¸Šæ›¸ãã—ã¦ã„ã¾ã™ãŒã€ä»£è¡¨çš„ãªã‚³ãƒ¼ãƒ‰ã¯ä¸‹è¨˜ã§ã™ã€‚

```
// extensionBase.ts
  overrideCommand(context, 'type', async (args: { text: string }) => {
    taskQueue.enqueueTask(async () => {
      const mh = await getAndUpdateModeHandler();
      if (mh) {
        if (compositionState.isInComposition) {
          compositionState.composingText += args.text;
          if (mh.vimState.currentMode === Mode.Insert) {
            compositionState.insertedText = true;
            void vscode.commands.executeCommand('default:type', { text: args.text });
          }
        } else {
          await mh.handleKeyEvent(args.text);
        }
      }
    });
  });
```

ã•ã¦ã€ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ãŸæ™‚ã«ã„ãã¤ã‹åˆ†å²ã¯ã‚ã‚Šã¾ã™ãŒã€ã»ã¨ã‚“ã©ã®ã‚±ãƒ¼ã‚¹ã§ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯ `ModeHandler` å‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã® `mh` ã«å‡¦ç†ã‚’å‡¦ç†ã—ã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚  
`if (compositionState.isInComposition)` ã®ã‚±ãƒ¼ã‚¹ã¯ IME ãªã©ã‚’ä½¿ã£ã¦ã„ã‚‹å°‘ã—ç‰¹æ®Šãªã‚±ãƒ¼ã‚¹ãªã®ã§ã€åŸºæœ¬å½¢ã®å‡¦ç†ã¯ `await mh.handleKeyEvent(args.text);` ã§è¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚  
ã“ã¡ã‚‰ã®å‡¦ç†ã‚’ã•ã‚‰ã«è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

## ã‚­ãƒ¼ã‹ã‚‰ Action ã®å–å¾—

`ModeHandler` ã® `handleKeyEvent` ãƒ¡ã‚½ãƒƒãƒ‰ã§è¡Œã£ã¦ã„ã‚‹ã“ã¨ã¯ã„ãã¤ã‹ã‚ã‚Šã¾ã™ãŒã€ã¾ãšæœ€åˆã«è¡Œã£ã¦ã„ã‚‹ã®ã¯ã‚­ãƒ¼ã‚’ Action ã«å¤‰æ›ã™ã‚‹ã“ã¨ã§ã™ã€‚  
ã“ã“ã§ Action ã¨ã¯ä½•ã‹ã‚’ç°¡å˜ã«è§£èª¬ã—ã¦ãŠãã¾ã™ã€‚

Action ã¨ã¯ä¸€è¨€ã§ã„ã†ã¨ã€ä¸€ã¤ã®ã‚­ãƒ¼å…¥åŠ›ã‹ã‚‰å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ Vim ã®å‡¦ç†å˜ä½ã®ã“ã¨ã§ã™ã€‚  
å…·ä½“ä¾‹ã¨ã—ã¦ Insert ãƒ¢ãƒ¼ãƒ‰ã§æ–‡å­—å…¥åŠ›ã‚’ã™ã‚‹ä¾‹ã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚  
ã“ã“ã§ã¯ã€Normal ãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰ Insert ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚Šã€Œabcã€ã¨ã„ã†æ–‡å­—ã‚’å…¥åŠ›ã— Esc ã‚­ãƒ¼ã§ Normal ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚‹å‹•ä½œã‚’è¡Œã†ã¨ã—ã¾ã™ã€‚  
ã“ã“ã§ã®å®Ÿéš›ã®ã‚­ãƒ¼å…¥åŠ›ã¯ã€Œiabc<Esc>ã€ã¨ãªã‚‹ã¯ãšã§ã™ãŒã€ãã‚Œãã‚Œæ¬¡ã® Action ã«å¤‰æ›ã•ã‚Œã¾ã™ã€‚

- i: CommandInsertAtCursor
- a: CommandInsertInInsertMode
- b: CommandInsertInInsertMode
- c: CommandInsertInInsertMode
- <Esc>: CommandEscInsertMode

ãã‚Œãã‚Œã®å‡¦ç†ã¨ã—ã¦ã¯ã€

- CommandInsertAtCursor: Insert ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã‚‹å‡¦ç†
- CommandInsertInInsertMode: Insert ãƒ¢ãƒ¼ãƒ‰ä¸­ã«æ–‡å­—ã‚’å…¥åŠ›ã™ã‚‹å‡¦ç†
- CommandEscInsertMode: Insert ãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰ Normal ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚‹å‡¦ç†

ãã—ã¦å„ Action ã«ã¯å®Ÿéš›ã«ãã‚Œãã‚Œã®å‡¦ç†ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®ã‚³ãƒ¼ãƒ‰ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã•ã¦ã€ã“ã“ã§ã‚­ãƒ¼ã‹ã‚‰ Action ã‚’å–å¾—ã™ã‚‹è©±ã—ã«æˆ»ã‚Šã¾ã™ãŒã€å…·ä½“çš„ã«ã¯ `ModeHandler` ã® `handleKeyAsAnAction` ãƒ¡ã‚½ãƒƒãƒ‰å†…éƒ¨ã® `getRelevantAction` ãƒ¡ã‚½ãƒƒãƒ‰ã§å–å¾—ã—ã¦ã„ã¾ã™ã€‚

```
// src/mode/modeHandler.ts
  private async handleKeyAsAnAction(key: string): Promise<boolean> {
    if (vscode.window.activeTextEditor !== this.vimState.editor) {
      Logger.warn('Current window is not active');
      return false;
    }

    // Catch any text change not triggered by us (example: tab completion).
    this.vimState.historyTracker.addChange();

    const recordedState = this.vimState.recordedState;
    recordedState.actionKeys.push(key);
    void VSCodeContext.set('vim.command', recordedState.commandString);

    const action = getRelevantAction(recordedState.actionKeys, this.vimState);
    // çœç•¥
  }
```

`getRelavantAction` ãƒ¡ã‚½ãƒƒãƒ‰ã®ç¬¬ä¸€å¼•æ•°ã§å…¥åŠ›ã•ã‚ŒãŸã‚­ãƒ¼æƒ…å ±ã€ç¬¬äºŒå¼•æ•°ã§çŠ¶æ…‹ç®¡ç†ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚‹ `vimState` ãŒæ¸¡ã•ã‚Œã¦ãŠã‚Šã€ã“ã® 2 ã¤ã®æƒ…å ±ã‹ã‚‰å¯¾å¿œã™ã‚‹ Action ã‚’æ±ºå®šã—ã¦ã„ã¾ã™ã€‚

## Action ã®å®Ÿè¡Œ

æ±ºå®šã•ã‚ŒãŸ Action ã‹ã‚‰å®Ÿéš›ã«ãã® Action ã®å®Ÿè¡Œã¸ã¨ç§»ã£ã¦ã„ãã¾ã™ã€‚  
å…·ä½“çš„ã«ã¯åŒã˜ã `ModeHandler` ã® `handleKeyAsAnAction` ãƒ¡ã‚½ãƒƒãƒ‰å†…éƒ¨ã® `runAction` ãƒ¡ã‚½ãƒƒãƒ‰ã‹ã‚‰å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚  
ã“ã“ã§ã¯ `runAction` ã®è©³ç´°ã‚’è¦‹ã‚‹ã‚ˆã‚Šã‚‚å‘¼ã³å‡ºã•ã‚Œã‚‹ Action ã®å®šç¾©ã‚’è©³ã—ãè¦‹ã¦ã„ããŸã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚

ã“ã“ã§ã¯å…ˆç¨‹ã® `CommandInsertAtCursor` ã‚’ä¾‹ã¨ã—ã¦å–ã‚Šä¸Šã’ã¾ã™ã€‚

```
// src/actions/commands/action.ts
@RegisterAction
export class CommandInsertAtCursor extends BaseCommand {
  modes = [Mode.Normal];
  keys = [['i'], ['<Insert>']];

  public override async exec(position: Position, vimState: VimState): Promise<void> {
    await vimState.setCurrentMode(Mode.Insert);
  }

  // çœç•¥
}
```

Action ã®ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…ã®å¤§ããªç‰¹å¾´ã¨ã—ã¦ä¸‹è¨˜ãŒã‚ã‚Šã¾ã™ã€‚

- `RegisterAction` ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãŒä»˜ä¸  
  ã“ã‚Œã«ã‚ˆã‚Šä¸Šè¨˜ã® `getRelevantAction` ã§ã‚­ãƒ¼ã‹ã‚‰å–å¾—ã™ã‚‹ Action ã®å¯¾è±¡ã¨ãªã‚Šã¾ã™ã€‚
- `modes` ã¨ `keys` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¿æŒ  
  `getRelevantAction` ã§é¸æŠã•ã‚Œã‚‹ Action ã®æ¡ä»¶å®šç¾©ã€‚
- `exec` ãƒ¡ã‚½ãƒƒãƒ‰  
  Action ã®å®Ÿè¡Œå‡¦ç†å†…å®¹ã€‚

ã‚ˆã£ã¦é¸æŠã•ã‚ŒãŸ Action ã«ã‚ˆã£ã¦å®Ÿè¡Œã•ã‚Œã‚‹å®Ÿéš›ã®å†…å®¹ã¯ `exec` ãƒ¡ã‚½ãƒƒãƒ‰ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚  
ã“ã“ã§å¤§ã¾ã‹ã«åˆ†ã‘ã‚‹ã¨ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§å®Ÿè¡Œã•ã‚Œã‚‹å†…å®¹ã¯ä¸‹è¨˜ã® 2 ç¨®é¡ã§ã™ã€‚

1. çŠ¶æ…‹ã®æ›´æ–°
2. Transformation ã®ç™»éŒ²

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ `await vimState.setCurrentMode(Mode.Insert)` ãŒ 1 ã®çŠ¶æ…‹ã®æ›´æ–°ã«å½“ãŸã‚Šã¾ã™ã€‚
å…·ä½“çš„ã«ã¯ Normal ãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰ Insert ãƒ¢ãƒ¼ãƒ‰ã¸ã®åˆ‡ã‚Šæ›¿ãˆå‡¦ç†ã§ã™ã€‚

2 ã® Transformation ã®ç™»éŒ²ã«ã¤ã„ã¦èª¬æ˜ã™ã‚‹å‰ã«ã€ã¾ãš Transformation ã¨ã¯ä½•ã‹ã‚’è§£èª¬ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

Transformation ã¯å®Ÿéš›ã®ãƒ†ã‚­ã‚¹ãƒˆã®æ›´æ–°ã‚’å‡¦ç†ã‚’ä»¥ä¸Šã™ã‚‹ãŸã‚ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚

ã¯ `CommandInsertAtCursor` ã§ã¯è¡Œã£ã¦ã„ãªã„ãŸã‚ åˆ¥ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

`CommandInsertInInsertMode` ã‚’ä»£ã‚ã‚Šã«è¦‹ã¦ã„ãã¾ã™ã€‚

```
@RegisterAction
export class CommandInsertInInsertMode extends BaseCommand {
  modes = [Mode.Insert];
  keys = ['<character>'];

  public override async exec(position: Position, vimState: VimState): Promise<void> {
    const char = this.keysPressed.at(-1)!;

    let text = char;

    // çœç•¥

    vimState.recordedState.transformer.addTransformation({
      type: 'insertTextVSCode',
      text,
      isMultiCursor: vimState.isMultiCursor,
    });
  }

  // çœç•¥
}
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ `vimState.recordedState.transformer.addTransformation` ã‚’å‘¼ã³å‡ºã— `insertTextVSCode` ã® Transformation ã‚’ç™»éŒ²ã—ã¦ã„ã¾ã™ã€‚  
ã“ã® Transformation ã¯

## ãŠã‚ã‚Šã«
